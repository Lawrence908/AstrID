## **ASTR-75: FITS Processing Pipeline (P2) - Core domain**

### **Context & Current State**
The observation domain models and services are complete (ASTR-73 ), and we have basic FITS file reading/writing and WCS handling implemented. This ticket completes the FITS processing pipeline by adding star catalog integration and enhancing the existing functionality for production use.

### **Technical Requirements**

**Dependencies**: ASTR-73 (Observation Models and Services) -  Complete
**Domain**: Core Domain (Data Processing)
**Estimated Time**: 3 days

### **Implementation Tasks**

1. **Enhance FITS File Reading and Writing**  **PARTIALLY COMPLETE**
   - Enhance `src/domains/observations/processors/fits_processor.py`
   - Add advanced FITS handling:
     - `read_fits_with_validation(file_path: str) -> tuple[ndarray, dict]`
     - `write_fits_with_metadata(data: ndarray, headers: dict, file_path: str) -> None`
     - `validate_fits_structure(file_path: str) -> bool`
     - `extract_all_headers(file_path: str) -> dict`
   - Add support for multi-extension FITS files
   - Implement FITS compression and optimization
   - Add FITS file integrity verification

2. **Enhance WCS (World Coordinate System) Handling**  **PARTIALLY COMPLETE**
   - Enhance `src/domains/observations/processors/wcs_processor.py`
   - Add advanced WCS operations:
     - `pixel_to_world_coordinates(pixel_coords: ndarray, wcs: WCS) -> tuple[ndarray, ndarray]`
     - `world_to_pixel_coordinates(world_coords: tuple, wcs: WCS) -> ndarray`
     - `validate_wcs_solution(wcs: WCS) -> bool`
     - `calculate_sky_region_bounds(wcs: WCS, image_shape: tuple) -> dict`
     - `transform_coordinates(coords: tuple, from_system: str, to_system: str) -> tuple`
   - Add support for different coordinate systems (ICRS, FK5, Galactic)
   - Implement coordinate system transformations
   - Add WCS solution quality assessment

3. **Enhance Image Metadata Extraction**  **PARTIALLY COMPLETE**
   - Enhance `src/domains/observations/processors/metadata_extractor.py`
   - Add comprehensive metadata extraction:
     - `extract_photometric_parameters(fits_data: bytes) -> dict`
     - `extract_observing_conditions(fits_data: bytes) -> dict`
     - `extract_instrument_parameters(fits_data: bytes) -> dict`
     - `extract_quality_metrics(fits_data: bytes) -> dict`
     - `extract_astrometric_solution(fits_data: bytes) -> dict`
   - Add support for different telescope and instrument formats
   - Implement metadata validation and standardization
   - Add metadata completeness scoring

4. **Implement Star Catalog Integration** ❌ **NEW TASK**
   - Create `src/domains/observations/catalogs/star_catalog.py`
   - Implement `StarCatalog` with methods:
     - `query_stars_in_region(ra: float, dec: float, radius: float) -> list[dict]`
     - `get_star_by_id(star_id: str) -> dict`
     - `match_stars_to_image(stars: list[dict], wcs: WCS, image_shape: tuple) -> list[dict]`
     - `calculate_star_magnitudes(stars: list[dict], filter_band: str) -> list[float]`
   - Add support for multiple star catalogs:
     - Gaia DR3 for astrometric reference
     - Tycho-2 for photometric reference
     - USNO-B1.0 for historical data
   - Implement catalog cross-matching
   - Add star catalog caching and indexing

### **Integration Points**

- **Domain Models**: Enhanced observation metadata from FITS processing
- **Repository Layer**: Store processed FITS metadata in database
- **Service Layer**: Use processed data in observation validation
- **Storage**: Store processed FITS files in cloud storage
- **Events**: Emit processing completion events

### **FITS Processing Pipeline**
```python
@dataclass
class FITSProcessingResult:
    image_data: ndarray
    wcs_solution: WCS
    metadata: dict
    quality_metrics: dict
    star_catalog_matches: list[dict]
    processing_errors: list[str]
    processing_time: float
```

### **API Endpoints to Add**
```python
POST /observations/{id}/process-fits
GET /observations/{id}/fits-metadata
POST /observations/{id}/validate-wcs
GET /observations/{id}/star-catalog-matches
POST /observations/{id}/extract-photometry
```

### **Star Catalog Configuration**
```python
@dataclass
class StarCatalogConfig:
    catalogs: list[str]  # ['gaia', 'tycho2', 'usnob1']
    search_radius: float  # arcseconds
    magnitude_limit: float
    cache_size: int
    update_frequency: str  # 'daily', 'weekly', 'monthly'
```

### **Error Handling**
- FITS file corruption detection and recovery
- WCS solution validation and fallback methods
- Star catalog query failures and retry logic
- Memory management for large FITS files
- Comprehensive logging for debugging

### **Testing Strategy**
- Unit tests for all FITS processing functions
- Integration tests with real FITS files
- WCS accuracy validation tests
- Star catalog matching accuracy tests
- Performance tests for large datasets
- Error handling tests for corrupted files

### **Performance Considerations**
- Lazy loading for large FITS files
- Parallel processing for multiple files
- Caching for frequently accessed star catalog data
- Memory-efficient processing for large images
- Progress tracking for long-running operations
