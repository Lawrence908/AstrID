## **ASTR-73: Observation Models and Services (P1) - Core domain**

### **Context & Current State**
The observation domain models exist in `src/domains/observations/models.py` but the service layer and repository interfaces need implementation. This is a critical P1 ticket that enables the entire observation processing pipeline.

### **Technical Requirements**

**Dependencies**: ASTR-70 (Database Setup) -  Complete
**Domain**: Core Domain (Observations)
**Estimated Time**: 3 days

### **Implementation Tasks**

1. **Implement Observation Domain Models**
   - Complete `Observation` and `Survey` models in `src/domains/observations/models.py`
   - Add business logic methods:
     - `Observation.validate_coordinates()`
     - `Observation.calculate_airmass()`
     - `Observation.get_processing_status()`
   - Implement domain events:
     - `ObservationIngested`
     - `ObservationStatusChanged`
     - `ObservationFailed`

2. **Create Observation Repository Interface**
   - Create `src/domains/observations/repositories.py`
   - Implement `ObservationRepository` interface with:
     - `create(observation: Observation) -> Observation`
     - `get_by_id(id: UUID) -> Observation | None`
     - `get_by_survey(survey_id: UUID) -> list[Observation]`
     - `get_by_status(status: ObservationStatus) -> list[Observation]`
     - `update_status(id: UUID, status: ObservationStatus) -> None`
     - `get_by_coordinates(ra: float, dec: float, radius: float) -> list[Observation]`
   - Add pagination and filtering support

3. **Implement Observation Service Layer**
   - Create `src/domains/observations/services/observation_service.py`
   - Implement `ObservationService` with business logic:
     - `create_observation(data: ObservationCreate) -> Observation`
     - `update_observation_status(id: UUID, status: ObservationStatus) -> Observation`
     - `get_observations_by_survey(survey_id: UUID) -> list[Observation]`
     - `validate_observation_data(data: ObservationCreate) -> bool`
     - `calculate_observation_metrics(observation: Observation) -> dict`
   - Add transaction management and error handling

4. **Add Observation Validation Logic**
   - Create `src/domains/observations/validators.py`
   - Implement validation rules:
     - Coordinate validation (RA: 0-360°, Dec: -90-90°)
     - Exposure time validation (> 0)
     - Filter band validation (against survey capabilities)
     - Metadata completeness checks
   - Add custom validation exceptions

### **Integration Points**

- **Database**: SQLAlchemy models with proper relationships
- **Events**: Domain events for workflow orchestration
- **Validation**: Comprehensive input validation
- **Storage**: Integration with R2 for file references

### **API Endpoints to Add**
```python
POST /observations
GET /observations/{observation_id}
GET /observations?survey_id={id}&status={status}
PUT /observations/{observation_id}/status
GET /observations/search?ra={ra}&dec={dec}&radius={radius}
```

### **Domain Events**
```python
@dataclass
class ObservationIngested:
    observation_id: UUID
    survey_id: UUID
    observation_time: datetime
    coordinates: tuple[float, float]

@dataclass
class ObservationStatusChanged:
    observation_id: UUID
    old_status: ObservationStatus
    new_status: ObservationStatus
    changed_at: datetime
```

### **Testing Strategy**
- Unit tests for all domain models and services
- Integration tests with database
- Validation tests for edge cases
- Performance tests for large datasets