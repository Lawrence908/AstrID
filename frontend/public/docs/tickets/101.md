# ASTR-101: GPU Energy Tracking for ML Workloads

## Summary
Implement GPU power consumption and carbon footprint tracking for ML training and inference, with storage in the database and logging to MLflow.

## Motivation
Quantifying energy use enables environmental impact analysis, cost estimation, and efficiency comparisons across models and runs.

## Scope
- GPU power monitoring during training and inference
- Database schema extensions for energy metrics storage
- MLflow integration for experiment tracking
- Analysis tools for carbon and cost reporting
- Integration with existing Prefect workflows

## Completed Work
- Core Infrastructure
  - GPU Power Monitor (`src/core/gpu_monitoring.py`) with real-time sampling via `nvidia-smi`
  - Energy calculation (Wh) and carbon footprint estimation
  - Async context manager for workflow integration
- Database Schema Extensions
  - Extended `Model` (training energy) and `ModelRun` (inference energy)
  - Updated Pydantic schemas
- Integration Components
  - Prefect flow integration (`src/adapters/scheduler/flows/model_training.py`)
  - MLflow energy tracking (`src/core/mlflow_energy.py`)
- Analysis & Reporting
  - Energy analysis tools (`src/core/energy_analysis.py`)
  - Demo script (`scripts/energy_tracking_example.py`)

## Technical Implementation
### Database Changes
- Model additions: `training_energy_wh DECIMAL(10,4)`, `training_avg_power_w DECIMAL(8,2)`, `training_peak_power_w DECIMAL(8,2)`, `training_duration_seconds INTEGER`, `training_carbon_footprint_kg DECIMAL(10,6)`
- ModelRun additions: `energy_consumed_wh DECIMAL(8,4)`, `avg_power_draw_w DECIMAL(6,2)`, `peak_power_draw_w DECIMAL(6,2)`, `carbon_footprint_g DECIMAL(8,4)`

### Key Features
- Real-time GPU power sampling (1Hz default)
- Carbon intensity calculation (233 gCO2/kWh default)
- Electricity cost estimation ($0.12/kWh default)
- MLflow experiment tracking with energy tags
- Automatic integration with training flows

### Metrics Tracked
- Training: total Wh, avg/peak W, duration, carbon (kg), efficiency
- Inference: energy per prediction, power per run, carbon per batch, GPU efficiency

## Use Cases
- Academic analysis, environmental impact, efficiency research
- Production optimization, cost analysis, compliance reporting

## Testing
- Manual: demo script, GPU detection and fallback, MLflow logging
- Integration: Prefect compatibility, schema migrations, API functionality

## Documentation
- Inline code docs, demo usage examples, methodology, carbon calculation details

## Deployment Notes
- Requirements: `nvidia-smi`, MLflow, DB migration
- Configuration: sampling interval, carbon intensity, electricity cost
- Monitoring: simulation mode, graceful degradation, error handling

## Future Enhancements
- Web dashboard, real-time alerts, cloud carbon APIs, recommendations, multi-GPU support

## Acceptance Criteria
- GPU power tracked during training
- Energy metrics stored in DB
- MLflow integration functional
- Carbon footprint calculation and reporting
- Analysis tools for efficiency comparison
- Demo script validates functionality; docs provided

---

## Operational Details
### Configuration
- Environment Variables:
  - `ASTRID_CARBON_INTENSITY_G_PER_KWH` (default: 233)
  - `ASTRID_ELECTRICITY_COST_USD_PER_KWH` (default: 0.12)
  - `ASTRID_GPU_POWER_SAMPLING_HZ` (default: 1)
  - `MLFLOW_TRACKING_URI`, `PREFECT_API_URL`, `DATABASE_URL`
- Connection Pooling (Supabase): append `?pool_size=1&max_overflow=0&connect_timeout=10`; prefer transaction pooling when compatible

### MLflow Integration
- Tags/Params: `energy.total_wh`, `energy.avg_power_w`, `energy.peak_power_w`, `energy.carbon_g|kg`, `energy.sampling_hz`, `energy.method`
- Artifacts: `energy/power_trace.csv`, `energy/summary.json`

### Prefect Integration
- Wrap tasks with async context manager; emit metrics into task results and MLflow

### API Impacts
- Extended payloads include energy stats; health includes `gpu_monitor` status

### Testing Strategy
- Unit tests for sampler; integration tests with simulated `nvidia-smi`; soak test for stability

### Troubleshooting
- No GPU → simulation mode; missing `nvidia-smi` → install drivers; zero spikes → adjust sampling; DB pool exhaustion → reduce pool size

### Metrics Dictionary
- `total_energy_wh`, `avg_power_w`, `peak_power_w`, `duration_seconds`, `carbon_footprint_g|kg`, `energy_per_prediction_wh`

### Acceptance Test Plan
1. Run demo on GPU and verify DB persistence
2. Confirm MLflow tags and `energy/power_trace.csv`
3. Validate Prefect task metrics
4. Toggle simulation and verify `simulated=true`
5. Validate cost estimation respects env var