# ASTR-103: Supabase Connection Pooling Hardening

## Summary
Prevent `MaxClientsInSessionMode` errors by minimizing per-service connection pools, aligning MLflow/Prefect DB URLs with explicit pool parameters, and validating compatibility with Supabase Transaction pooling.

## Motivation
Multiple processes (API, MLflow, Prefect, workers) each maintain a DB pool. In Supabase Session mode this can exceed client caps, causing outages. We must constrain pools and optionally migrate to transaction pooling where compatible.

## Scope
- Update MLflow backend-store DB URL with pool parameters
- Update Prefect server DB URL with pool parameters
- Document and validate Transaction pooling compatibility
- Add verification steps and health checks

## Acceptance Criteria
- No `MaxClientsInSessionMode` errors after 24h soak under typical workload
- MLflow and Prefect URLs include `pool_size=1&max_overflow=0` and timeouts
- README/guide explains Transaction pooling compatibility and rollout
- Health endpoint confirms DB connectivity; logs show stable operation

## Implementation Plan
1) MLflow
- Edit `docker-compose.yaml` → `mlflow.command` backend-store-uri:
  - Append `?pool_size=1&max_overflow=0&connect_timeout=10`.
- Keep Gunicorn workers at 1; keep timeouts and max-requests.

2) Prefect Server
- Edit `docker-compose.yaml` → `PREFECT_SERVER_DATABASE_CONNECTION_URL`:
  - Append `?pool_size=1&max_overflow=0&timeout=10`.

3) Transaction Pooling (optional but recommended)
- If Supabase exposes Transaction pooler host, point `${SUPABASE_HOST}`, `${MLFLOW_SUPABASE_HOST}`, `${PREFECT_SUPABASE_HOST}` to it.
- Ensure code paths avoid session-level features (temp tables, long-held sessions, server-side cursors across txns, advisory locks).

4) Verification
- Rebuild and restart: `docker-compose up --build -d`
- Watch logs for 10–15 minutes: `docker-compose logs -f`
- Confirm no pool exhaustion messages; validate API `/health` and MLflow `/health`.

## Rollback Plan
- Revert compose changes and redeploy.
- Raise pool_size back to 2 only after increasing Supabase limits.

## References
- docs/guides/supabase-pooling.md
- docker-compose.yaml
- src/core/constants.py


