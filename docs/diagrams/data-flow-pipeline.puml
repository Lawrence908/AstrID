@startuml AstrID Data Flow Pipeline
!theme cerulean
skinparam backgroundColor #0D1117
skinparam defaultFontName Arial
skinparam defaultFontSize 12

title AstrID Data Flow Pipeline

start

:Supernova Catalog;
note right: sncat_latest_view.txt

:Query MAST for SN Observations;
note right: Reference (before) + Science (after)

:Download FITS Files;
note right: Store locally

:External Survey APIs;
note right: MAST, SkyView, etc.

:Observation Ingestion;
note right: ASTR-74: Survey Integration
note right: SN Catalog Workflow

:Store Raw FITS;
note right: Cloudflare R2 Storage

:Create Observation Record;
note right: PostgreSQL Database

:Trigger Preprocessing;
note right: Dramatiq Worker

if (Calibration frames available?) then (yes)
  :Apply Calibration;
  note right: Bias/Dark/Flat correction
else (no)
  :Skip calibration;
endif

:WCS Alignment;
note right: World Coordinate System

:Image Registration;
note right: Astrometric alignment

:Store Processed Image;
note right: R2 Storage

:Trigger Differencing;
note right: Dramatiq Worker

if (Reference image exists?) then (yes)
  if (SN catalog reference?) then (yes)
    :Use SN Catalog Reference;
    note right: Pre-discovery image
  else (no)
    :Select Reference Image;
    note right: Historical survey data
  endif
else (no)
  :Fetch reference from SkyView;
endif

:Apply ZOGY Algorithm;
note right: ASTR-78: Image Differencing

:Extract Sources;
note right: SEP/photutils

:Filter Candidates;
note right: Quality thresholds

:Store Difference Image;
note right: R2 Storage

:Trigger ML Detection;
note right: Dramatiq Worker

:Load U-Net Model;
note right: ASTR-80: U-Net Integration

:Run Inference;
note right: Anomaly detection

:Score Detections;
note right: Confidence scoring

:Store Detection Results;
note right: Database + R2

:Trigger Validation;
note right: Human review queue

:Human Review;
note right: ASTR-82: Human Validation

:Assign Labels;
note right: Valid/Invalid/Type

:Update Detection Status;
note right: Database update

if (Alert threshold exceeded?) then (yes)
  :Generate Alerts;
  note right: ASTR-82: Alert System
else (no)
  :No alert;
endif

:Catalog Results;
note right: ASTR-83: Data Cataloging

:Export Data;
note right: Final results

stop

@enduml
