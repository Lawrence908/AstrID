## **ASTR-74: Survey Integration (P2) - Core domain**

### **Context & Current State**
The observation domain models and services are complete (ASTR-73 ✅), but we need to integrate with external astronomical survey APIs to enable data ingestion from real astronomical surveys. This ticket implements the integration layer that connects our domain models to external data sources.

### **Technical Requirements**

**Dependencies**: ASTR-73 (Observation Models and Services) - ✅ Complete
**Domain**: Core Domain (Observations)
**Estimated Time**: 4 days

### **Implementation Tasks**

1. **Integrate with MAST API for Observations**
   - Create `src/domains/observations/integrations/mast_client.py`
   - Implement `MASTClient` with methods:
     - `search_observations(survey_id: str, coordinates: tuple, radius: float) -> list[dict]`
     - `get_observation_metadata(observation_id: str) -> dict`
     - `download_observation_data(observation_id: str) -> bytes`
   - Add authentication and rate limiting
   - Handle MAST API response parsing and error handling

2. **Integrate with SkyView for Image Data**
   - Create `src/domains/observations/integrations/skyview_client.py`
   - Implement `SkyViewClient` with methods:
     - `get_survey_image(coordinates: tuple, survey: str, size: int) -> bytes`
     - `get_multiple_surveys(coordinates: tuple, surveys: list[str]) -> dict[str, bytes]`
     - `get_image_metadata(image_data: bytes) -> dict`
   - Add image format validation and conversion
   - Implement retry logic for failed requests

3. **Implement Survey-Specific Adapters**
   - Create `src/domains/observations/adapters/`
   - Implement adapter pattern for different survey types:
     - `HSTAdapter` for Hubble Space Telescope data
     - `JWSTAdapter` for James Webb Space Telescope data
     - `SDSSAdapter` for Sloan Digital Sky Survey data
     - `LSSTAdapter` for Legacy Survey of Space and Time data
   - Each adapter should implement:
     - `normalize_observation_data(raw_data: dict) -> ObservationCreate`
     - `extract_metadata(raw_data: dict) -> dict`
     - `validate_survey_specific_data(data: dict) -> bool`

4. **Add Observation Metadata Extraction**
   - Create `src/domains/observations/extractors/metadata_extractor.py`
   - Implement `MetadataExtractor` with methods:
     - `extract_fits_headers(fits_data: bytes) -> dict`
     - `extract_wcs_information(fits_data: bytes) -> dict`
     - `extract_photometric_parameters(fits_data: bytes) -> dict`
     - `extract_quality_metrics(fits_data: bytes) -> dict`
   - Add support for different FITS file formats
   - Implement coordinate system transformations

### **Integration Points**

- **Domain Models**: Convert external data to `ObservationCreate` DTOs
- **Repository Layer**: Store ingested observations via existing repository
- **Service Layer**: Use existing `ObservationService` for business logic
- **Storage**: Store raw data files in R2 cloud storage
- **Events**: Emit `ObservationIngested` events for workflow orchestration

### **API Endpoints to Add**
```python
POST /surveys/{survey_id}/ingest
GET /surveys/{survey_id}/observations
POST /surveys/{survey_id}/search
GET /surveys/{survey_id}/metadata/{observation_id}
POST /surveys/{survey_id}/download/{observation_id}
```

### **Survey Configuration**
```python
@dataclass
class SurveyConfig:
    survey_id: str
    api_endpoint: str
    authentication: dict
    supported_filters: list[str]
    coordinate_system: str
    data_format: str
    rate_limits: dict
    retry_policy: dict
```

### **Error Handling**
- API rate limiting and retry logic
- Network timeout handling
- Data validation and sanitization
- Graceful degradation when services are unavailable
- Comprehensive logging for debugging

### **Testing Strategy**
- Unit tests for all integration clients
- Mock external API responses for testing
- Integration tests with real API endpoints (limited)
- Performance tests for large data downloads
- Error handling tests for various failure scenarios

### **Configuration Requirements**
- Environment variables for API keys and endpoints
- Survey-specific configuration files
- Rate limiting and retry policy configuration
- Logging configuration for integration monitoring
