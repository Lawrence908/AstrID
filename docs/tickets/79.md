## **ASTR-79: Source Extraction (P2) - Core domain**

### **Context & Current State**
Image differencing algorithms are complete (ASTR-78 ), providing difference images for anomaly detection. This ticket implements source extraction and analysis from difference images using SEP (Source Extractor as a Python library) and photutils to identify and characterize potential astronomical sources.

### **Technical Requirements**

**Dependencies**: ASTR-78 (Image Differencing Algorithms) -  Complete
**Domain**: Core Domain (Algorithm)
**Estimated Time**: 3 days

### **Implementation Tasks**

1. **Integrate SEP for Source Extraction**
   - Create `src/domains/detection/extractors/sep_extractor.py`
   - Implement `SEPExtractor` with methods:
     - `extract_sources(image: ndarray, threshold: float) -> list[Source]`
     - `extract_sources_with_background(image: ndarray, background: ndarray) -> list[Source]`
     - `extract_sources_with_noise(image: ndarray, noise: ndarray) -> list[Source]`
     - `extract_sources_with_mask(image: ndarray, mask: ndarray) -> list[Source]`
     - `calculate_source_flux(sources: list[Source], image: ndarray) -> list[float]`
   - Add SEP configuration and parameter tuning
   - Implement source detection quality assessment
   - Add support for different detection algorithms

2. **Add Photutils for Additional Analysis**
   - Create `src/domains/detection/analyzers/photutils_analyzer.py`
   - Implement `PhotutilsAnalyzer` with methods:
     - `analyze_source_properties(sources: list[Source], image: ndarray) -> list[dict]`
     - `calculate_aperture_photometry(sources: list[Source], image: ndarray) -> list[dict]`
     - `measure_source_morphology(sources: list[Source], image: ndarray) -> list[dict]`
     - `detect_source_peaks(sources: list[Source], image: ndarray) -> list[dict]`
     - `calculate_source_statistics(sources: list[Source], image: ndarray) -> dict`
   - Add advanced photometric analysis
   - Implement source classification algorithms
   - Add source quality metrics calculation

3. **Implement Candidate Filtering**
   - Create `src/domains/detection/filters/candidate_filter.py`
   - Implement `CandidateFilter` with methods:
     - `filter_by_flux(sources: list[Source], min_flux: float, max_flux: float) -> list[Source]`
     - `filter_by_snr(sources: list[Source], min_snr: float) -> list[Source]`
     - `filter_by_size(sources: list[Source], min_size: float, max_size: float) -> list[Source]`
     - `filter_by_shape(sources: list[Source], max_ellipticity: float) -> list[Source]`
     - `filter_by_position(sources: list[Source], region_bounds: dict) -> list[Source]`
     - `filter_duplicates(sources: list[Source], min_distance: float) -> list[Source]`
   - Add machine learning-based filtering
   - Implement adaptive filtering based on image properties
   - Add filtering rule configuration and customization

4. **Create Candidate Scoring System**
   - Create `src/domains/detection/scorers/candidate_scorer.py`
   - Implement `CandidateScorer` with methods:
     - `calculate_detection_score(source: Source, image: ndarray) -> float`
     - `calculate_quality_score(source: Source, image: ndarray) -> float`
     - `calculate_anomaly_score(source: Source, reference: ndarray) -> float`
     - `calculate_confidence_score(source: Source, context: dict) -> float`
     - `rank_candidates(sources: list[Source], image: ndarray) -> list[Source]`
   - Add multi-criteria scoring algorithms
   - Implement score normalization and weighting
   - Add score confidence intervals and uncertainty

### **Integration Points**

- **Differencing Domain**: Process difference images from ASTR-78
- **Detection Domain**: Provide sources for anomaly detection
- **Storage**: Store source extraction results and metadata
- **Events**: Emit source extraction completion events
- **API**: Expose source extraction results via REST API

### **Source Data Structure**
```python
@dataclass
class Source:
    source_id: UUID
    coordinates: tuple[float, float]  # (x, y) pixel coordinates
    world_coordinates: tuple[float, float]  # (ra, dec) world coordinates
    flux: float
    flux_error: float
    snr: float
    size: float  # pixel area
    ellipticity: float
    position_angle: float
    peak_value: float
    background: float
    noise: float
    quality_flags: list[str]
    extraction_metadata: dict
```

### **API Endpoints to Add**
```python
POST /sources/extract/{observation_id}
GET /sources/{source_id}
GET /sources/observation/{observation_id}
POST /sources/filter
POST /sources/score
GET /sources/search?flux_min={min}&flux_max={max}
```

### **Source Extraction Configuration**
```python
@dataclass
class SourceExtractionConfig:
    detection_threshold: float
    min_pixels: int
    deblend_threshold: float
    deblend_cont: float
    clean_param: float
    filter_kernel: str
    background_estimation: str
    noise_estimation: str
    aperture_radius: float
    annulus_inner: float
    annulus_outer: float
```

### **Error Handling**
- Source extraction failure detection and recovery
- Image quality validation before extraction
- Memory management for large images
- Parameter validation and error reporting
- Comprehensive logging for debugging

### **Testing Strategy**
- Unit tests for all extraction algorithms
- Integration tests with real difference images
- Source detection accuracy validation
- Performance tests for large images
- Error handling tests for various failure scenarios

### **Performance Considerations**
- Parallel processing for multiple images
- Memory-efficient processing for large images
- Source extraction result caching
- Progress tracking for long-running operations
- Resource management for concurrent processing