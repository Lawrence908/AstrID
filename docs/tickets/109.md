## **ASTR-109: Anomaly Timeline Feature for React Frontend (P2) - API & Web Interface**

### **Context & Current State**
Anomaly detection pipeline is complete (ASTR-81 ✅) and core API endpoints are available (ASTR-84 ✅), providing the foundation for displaying detected anomalies. This ticket implements an interactive timeline feature for the React frontend to showcase detected anomalies over time, providing users with an engaging way to explore the project's achievements and discoveries.

### **Technical Requirements**

**Dependencies**: ASTR-81 (Anomaly Detection Pipeline) ✅ Complete, ASTR-84 (Core API Endpoints) ✅ Complete
**Domain**: API & Web Interface (Frontend Visualization)
**Estimated Time**: 3 days

### **Implementation Tasks**

1. **Create Timeline Component with Real-time Updates**
   - Create `frontend/components/AnomalyTimeline.tsx`:
     - Implement vertical timeline layout with chronological anomaly display
     - Add smooth animations and transitions for new anomalies
     - Include filtering and search capabilities
     - Support for different time ranges (24h, 7d, 30d, all time)
   - Create `frontend/components/TimelineEntry.tsx`:
     - Individual timeline entry component for each anomaly
     - Display key information (confidence, coordinates, survey, timestamp)
     - Visual indicators for anomaly priority and status
     - Hover effects and click handlers for details
   - Add real-time updates using WebSocket or Server-Sent Events:
     - Connect to existing API endpoints for live anomaly data
     - Implement automatic refresh and new anomaly notifications
     - Add loading states and error handling

2. **Implement Anomaly Detail Views and Navigation**
   - Create `frontend/app/dashboard/anomalies/[id]/page.tsx`:
     - Detailed anomaly view with full information
     - Image gallery with detection thumbnails
     - Metadata display (coordinates, survey info, processing details)
     - Related observations and historical context
   - Create `frontend/components/AnomalyDetailModal.tsx`:
     - Modal overlay for quick anomaly inspection
     - Zoom functionality for detection images
     - Action buttons (validate, flag, share)
     - Navigation between related anomalies
   - Add navigation breadcrumbs and back buttons
   - Implement deep linking for anomaly URLs

3. **Add External Resource Links and Sky Map Integration**
   - Create `frontend/components/ExternalResources.tsx`:
     - Links to astronomical databases (SIMBAD, VizieR, NED)
     - Integration with sky mapping services (Aladin, WorldWide Telescope)
     - Coordinate conversion utilities (RA/Dec to various formats)
     - Export functionality for observation data
   - Add sky map integration:
     - Embed interactive sky maps showing anomaly locations
     - Overlay detection regions and survey coverage
     - Link to external sky survey tools
   - Create resource link management:
     - Configurable external service URLs
     - User preference for default sky map service
     - Fallback options for different coordinate systems

4. **Design Responsive Timeline Layout for Homepage**
   - Update `frontend/app/page.tsx` to include timeline section:
     - Add prominent timeline section below main dashboard
     - Implement collapsible/expandable timeline view
     - Add timeline statistics and summary cards
     - Include "View All Anomalies" link to dedicated page
   - Create `frontend/app/dashboard/anomalies/page.tsx`:
     - Full-page timeline view with enhanced features
     - Advanced filtering and sorting options
     - Timeline export and sharing capabilities
     - Integration with curation workflow
   - Implement responsive design:
     - Mobile-optimized timeline layout
     - Touch-friendly interaction for tablets
     - Desktop hover effects and keyboard navigation

### **Integration Points**

- **Detection API**: Connect to ASTR-81 detection endpoints
- **Core API**: Use ASTR-84 API infrastructure
- **Authentication**: Integrate with existing Supabase auth
- **Real-time Updates**: Connect to existing WebSocket/SSE infrastructure
- **External Services**: Link to astronomical databases and sky maps

### **Timeline Component Structure**
```tsx
// frontend/components/AnomalyTimeline.tsx
import React, { useState, useEffect } from 'react'
import { TimelineEntry } from './TimelineEntry'
import { AnomalyDetailModal } from './AnomalyDetailModal'
import { ExternalResources } from './ExternalResources'

interface Anomaly {
  id: string
  detection_id: string
  confidence_score: number
  quality_score: number
  ra: number
  dec: number
  survey_name: string
  detection_time: string
  thumbnail_url?: string
  status: 'pending' | 'validated' | 'rejected'
  priority: 'low' | 'medium' | 'high' | 'critical'
}

interface AnomalyTimelineProps {
  timeRange?: '24h' | '7d' | '30d' | 'all'
  showFilters?: boolean
  maxEntries?: number
  onAnomalyClick?: (anomaly: Anomaly) => void
}

export const AnomalyTimeline: React.FC<AnomalyTimelineProps> = ({
  timeRange = '7d',
  showFilters = true,
  maxEntries = 50,
  onAnomalyClick
}) => {
  const [anomalies, setAnomalies] = useState<Anomaly[]>([])
  const [loading, setLoading] = useState(true)
  const [selectedAnomaly, setSelectedAnomaly] = useState<Anomaly | null>(null)
  const [filters, setFilters] = useState({
    minConfidence: 0.7,
    priority: 'all' as string,
    status: 'all' as string
  })

  useEffect(() => {
    fetchAnomalies()
    // Set up real-time updates
    const interval = setInterval(fetchAnomalies, 30000) // 30 seconds
    return () => clearInterval(interval)
  }, [timeRange, filters])

  const fetchAnomalies = async () => {
    try {
      const response = await fetch(`/api/anomalies?time_range=${timeRange}&limit=${maxEntries}`)
      const data = await response.json()
      setAnomalies(data.anomalies || [])
    } catch (error) {
      console.error('Failed to fetch anomalies:', error)
    } finally {
      setLoading(false)
    }
  }

  const handleAnomalyClick = (anomaly: Anomaly) => {
    setSelectedAnomaly(anomaly)
    onAnomalyClick?.(anomaly)
  }

  if (loading) {
    return <TimelineSkeleton />
  }

  return (
    <div className="anomaly-timeline">
      {showFilters && (
        <TimelineFilters 
          filters={filters} 
          onFiltersChange={setFilters}
        />
      )}
      
      <div className="timeline-container">
        {anomalies.map((anomaly, index) => (
          <TimelineEntry
            key={anomaly.id}
            anomaly={anomaly}
            index={index}
            onClick={() => handleAnomalyClick(anomaly)}
          />
        ))}
      </div>

      {selectedAnomaly && (
        <AnomalyDetailModal
          anomaly={selectedAnomaly}
          onClose={() => setSelectedAnomaly(null)}
        />
      )}
    </div>
  )
}
```

### **Timeline Entry Component**
```tsx
// frontend/components/TimelineEntry.tsx
import React from 'react'
import { Calendar, MapPin, Star, Eye, ExternalLink } from 'lucide-react'

interface TimelineEntryProps {
  anomaly: Anomaly
  index: number
  onClick: () => void
}

export const TimelineEntry: React.FC<TimelineEntryProps> = ({
  anomaly,
  index,
  onClick
}) => {
  const formatTime = (timestamp: string) => {
    return new Date(timestamp).toLocaleString()
  }

  const getPriorityColor = (priority: string) => {
    switch (priority) {
      case 'critical': return 'text-red-400 bg-red-900/20'
      case 'high': return 'text-orange-400 bg-orange-900/20'
      case 'medium': return 'text-yellow-400 bg-yellow-900/20'
      case 'low': return 'text-green-400 bg-green-900/20'
      default: return 'text-gray-400 bg-gray-900/20'
    }
  }

  return (
    <div 
      className="timeline-entry group cursor-pointer"
      onClick={onClick}
    >
      <div className="timeline-marker">
        <div className={`priority-indicator ${getPriorityColor(anomaly.priority)}`}>
          <Star className="w-3 h-3" />
        </div>
        {index < 10 && <div className="timeline-line" />}
      </div>

      <div className="timeline-content">
        <div className="anomaly-card">
          <div className="anomaly-header">
            <div className="anomaly-id">
              <span className="font-mono text-sm text-gray-400">
                {anomaly.detection_id.slice(0, 8)}
              </span>
              <span className={`priority-badge ${getPriorityColor(anomaly.priority)}`}>
                {anomaly.priority.toUpperCase()}
              </span>
            </div>
            <div className="anomaly-time">
              <Calendar className="w-4 h-4" />
              <span className="text-sm text-gray-400">
                {formatTime(anomaly.detection_time)}
              </span>
            </div>
          </div>

          <div className="anomaly-details">
            <div className="coordinates">
              <MapPin className="w-4 h-4" />
              <span className="font-mono text-sm">
                RA: {anomaly.ra.toFixed(6)}°, Dec: {anomaly.dec.toFixed(6)}°
              </span>
            </div>
            
            <div className="scores">
              <div className="score-item">
                <span className="score-label">Confidence:</span>
                <span className="score-value">
                  {(anomaly.confidence_score * 100).toFixed(1)}%
                </span>
              </div>
              <div className="score-item">
                <span className="score-label">Quality:</span>
                <span className="score-value">
                  {(anomaly.quality_score * 100).toFixed(1)}%
                </span>
              </div>
            </div>

            <div className="survey-info">
              <span className="survey-name">{anomaly.survey_name}</span>
              <span className={`status-badge status-${anomaly.status}`}>
                {anomaly.status.toUpperCase()}
              </span>
            </div>
          </div>

          {anomaly.thumbnail_url && (
            <div className="anomaly-thumbnail">
              <img 
                src={anomaly.thumbnail_url} 
                alt="Detection thumbnail"
                className="thumbnail-image"
              />
            </div>
          )}

          <div className="anomaly-actions">
            <button className="action-btn primary">
              <Eye className="w-4 h-4" />
              View Details
            </button>
            <button className="action-btn secondary">
              <ExternalLink className="w-4 h-4" />
              Sky Map
            </button>
          </div>
        </div>
      </div>
    </div>
  )
}
```

### **Anomaly Detail Modal**
```tsx
// frontend/components/AnomalyDetailModal.tsx
import React from 'react'
import { X, ExternalLink, Download, Share2, Flag } from 'lucide-react'
import { ExternalResources } from './ExternalResources'

interface AnomalyDetailModalProps {
  anomaly: Anomaly
  onClose: () => void
}

export const AnomalyDetailModal: React.FC<AnomalyDetailModalProps> = ({
  anomaly,
  onClose
}) => {
  return (
    <div className="modal-overlay" onClick={onClose}>
      <div className="modal-content" onClick={e => e.stopPropagation()}>
        <div className="modal-header">
          <h2 className="modal-title">
            Anomaly Detection Details
          </h2>
          <button className="close-btn" onClick={onClose}>
            <X className="w-5 h-5" />
          </button>
        </div>

        <div className="modal-body">
          <div className="anomaly-gallery">
            {/* Image gallery with zoom functionality */}
            <div className="main-image">
              <img 
                src={anomaly.thumbnail_url || '/images/placeholder-detection.png'} 
                alt="Detection image"
                className="detection-image"
              />
            </div>
            <div className="image-thumbnails">
              {/* Additional detection images */}
            </div>
          </div>

          <div className="anomaly-metadata">
            <div className="metadata-section">
              <h3>Detection Information</h3>
              <div className="metadata-grid">
                <div className="metadata-item">
                  <label>Detection ID:</label>
                  <span className="font-mono">{anomaly.detection_id}</span>
                </div>
                <div className="metadata-item">
                  <label>Confidence Score:</label>
                  <span className="score-highlight">
                    {(anomaly.confidence_score * 100).toFixed(1)}%
                  </span>
                </div>
                <div className="metadata-item">
                  <label>Quality Score:</label>
                  <span className="score-highlight">
                    {(anomaly.quality_score * 100).toFixed(1)}%
                  </span>
                </div>
                <div className="metadata-item">
                  <label>Survey:</label>
                  <span>{anomaly.survey_name}</span>
                </div>
                <div className="metadata-item">
                  <label>Detection Time:</label>
                  <span>{new Date(anomaly.detection_time).toLocaleString()}</span>
                </div>
              </div>
            </div>

            <div className="metadata-section">
              <h3>Coordinates</h3>
              <div className="coordinates-display">
                <div className="coord-item">
                  <label>Right Ascension:</label>
                  <span className="font-mono">{anomaly.ra.toFixed(8)}°</span>
                </div>
                <div className="coord-item">
                  <label>Declination:</label>
                  <span className="font-mono">{anomaly.dec.toFixed(8)}°</span>
                </div>
                <div className="coord-item">
                  <label>Galactic Coordinates:</label>
                  <span className="font-mono">
                    {convertToGalactic(anomaly.ra, anomaly.dec)}
                  </span>
                </div>
              </div>
            </div>

            <ExternalResources 
              ra={anomaly.ra} 
              dec={anomaly.dec}
              detectionId={anomaly.detection_id}
            />
          </div>
        </div>

        <div className="modal-footer">
          <div className="action-buttons">
            <button className="btn-secondary">
              <Flag className="w-4 h-4" />
              Flag for Review
            </button>
            <button className="btn-secondary">
              <Share2 className="w-4 h-4" />
              Share
            </button>
            <button className="btn-secondary">
              <Download className="w-4 h-4" />
              Export Data
            </button>
            <button className="btn-primary">
              <ExternalLink className="w-4 h-4" />
              View in Sky Map
            </button>
          </div>
        </div>
      </div>
    </div>
  )
}
```

### **External Resources Integration**
```tsx
// frontend/components/ExternalResources.tsx
import React from 'react'
import { ExternalLink, MapPin, Database, Globe } from 'lucide-react'

interface ExternalResourcesProps {
  ra: number
  dec: number
  detectionId: string
}

export const ExternalResources: React.FC<ExternalResourcesProps> = ({
  ra,
  dec,
  detectionId
}) => {
  const formatCoordinates = (ra: number, dec: number) => {
    return `${ra.toFixed(6)}+${dec.toFixed(6)}`
  }

  const externalLinks = [
    {
      name: 'Aladin Sky Atlas',
      url: `https://aladin.u-strasbg.fr/AladinLite/?target=${formatCoordinates(ra, dec)}&fov=0.1`,
      icon: <MapPin className="w-4 h-4" />,
      description: 'Interactive sky atlas'
    },
    {
      name: 'SIMBAD Database',
      url: `https://simbad.u-strasbg.fr/simbad/sim-coo?Coord=${formatCoordinates(ra, dec)}&Radius=0.1`,
      icon: <Database className="w-4 h-4" />,
      description: 'Astronomical database'
    },
    {
      name: 'VizieR Catalog',
      url: `https://vizier.u-strasbg.fr/viz-bin/VizieR-6?-c=${formatCoordinates(ra, dec)}&-c.rs=0.1`,
      icon: <Database className="w-4 h-4" />,
      description: 'Catalog service'
    },
    {
      name: 'WorldWide Telescope',
      url: `https://worldwidetelescope.org/webclient/?ra=${ra}&dec=${dec}&fov=0.1`,
      icon: <Globe className="w-4 h-4" />,
      description: 'Virtual observatory'
    }
  ]

  return (
    <div className="external-resources">
      <h3>External Resources</h3>
      <div className="resources-grid">
        {externalLinks.map((link, index) => (
          <a
            key={index}
            href={link.url}
            target="_blank"
            rel="noopener noreferrer"
            className="resource-link"
          >
            <div className="resource-icon">{link.icon}</div>
            <div className="resource-info">
              <div className="resource-name">{link.name}</div>
              <div className="resource-description">{link.description}</div>
            </div>
            <ExternalLink className="w-4 h-4 resource-arrow" />
          </a>
        ))}
      </div>
    </div>
  )
}
```

### **Homepage Integration**
```tsx
// Update to frontend/app/page.tsx
// Add after the Workers Status Card section

{/* Anomaly Timeline Section */}
<div className="mt-8">
  <div className="bg-gray-800 rounded-lg p-6 border border-gray-700">
    <div className="flex items-center justify-between mb-6">
      <div>
        <h2 className="text-2xl font-bold text-white mb-2">Recent Anomaly Detections</h2>
        <p className="text-gray-400">Timeline of discovered astronomical anomalies</p>
      </div>
      <Link
        href="/dashboard/anomalies"
        className="inline-flex items-center px-4 py-2 bg-astrid-blue text-white font-medium rounded-lg hover:bg-blue-600 transition-colors"
      >
        <Search className="w-4 h-4 mr-2" />
        View All Anomalies
      </Link>
    </div>

    <AnomalyTimeline 
      timeRange="7d"
      maxEntries={5}
      showFilters={false}
      onAnomalyClick={(anomaly) => {
        // Handle anomaly click - could open modal or navigate
        console.log('Anomaly clicked:', anomaly)
      }}
    />
  </div>
</div>
```

### **API Integration**
```typescript
// frontend/lib/api/anomalies.ts
export interface AnomalyAPIResponse {
  anomalies: Anomaly[]
  total: number
  page: number
  limit: number
  has_more: boolean
}

export const fetchAnomalies = async (
  timeRange: string = '7d',
  limit: number = 50,
  filters?: {
    minConfidence?: number
    priority?: string
    status?: string
  }
): Promise<AnomalyAPIResponse> => {
  const params = new URLSearchParams({
    time_range: timeRange,
    limit: limit.toString(),
    ...(filters?.minConfidence && { min_confidence: filters.minConfidence.toString() }),
    ...(filters?.priority && filters.priority !== 'all' && { priority: filters.priority }),
    ...(filters?.status && filters.status !== 'all' && { status: filters.status })
  })

  const response = await fetch(`/api/anomalies?${params}`)
  if (!response.ok) {
    throw new Error('Failed to fetch anomalies')
  }
  
  return response.json()
}
```

### **Styling and Responsive Design**
```css
/* frontend/styles/timeline.css */
.anomaly-timeline {
  @apply relative;
}

.timeline-container {
  @apply relative pl-8;
}

.timeline-entry {
  @apply relative mb-6;
}

.timeline-marker {
  @apply absolute -left-6 top-4 flex flex-col items-center;
}

.priority-indicator {
  @apply w-6 h-6 rounded-full flex items-center justify-center text-xs font-bold;
}

.timeline-line {
  @apply w-0.5 h-8 bg-gray-600 mt-2;
}

.anomaly-card {
  @apply bg-gray-700 rounded-lg p-4 border border-gray-600 hover:border-gray-500 transition-all duration-200 hover:shadow-lg;
}

.anomaly-header {
  @apply flex justify-between items-start mb-3;
}

.anomaly-id {
  @apply flex items-center space-x-2;
}

.priority-badge {
  @apply px-2 py-1 rounded-full text-xs font-medium;
}

.anomaly-time {
  @apply flex items-center space-x-1 text-gray-400;
}

.anomaly-details {
  @apply space-y-2 mb-4;
}

.coordinates {
  @apply flex items-center space-x-2 text-sm;
}

.scores {
  @apply flex space-x-4;
}

.score-item {
  @apply flex space-x-1;
}

.score-label {
  @apply text-gray-400 text-sm;
}

.score-value {
  @apply text-white font-medium text-sm;
}

.survey-info {
  @apply flex justify-between items-center;
}

.survey-name {
  @apply text-astrid-blue font-medium;
}

.status-badge {
  @apply px-2 py-1 rounded-full text-xs font-medium;
}

.status-pending {
  @apply bg-yellow-900 text-yellow-300;
}

.status-validated {
  @apply bg-green-900 text-green-300;
}

.status-rejected {
  @apply bg-red-900 text-red-300;
}

.anomaly-thumbnail {
  @apply mb-4;
}

.thumbnail-image {
  @apply w-full h-32 object-cover rounded-lg;
}

.anomaly-actions {
  @apply flex space-x-2;
}

.action-btn {
  @apply flex items-center space-x-1 px-3 py-1.5 rounded-md text-sm font-medium transition-colors;
}

.action-btn.primary {
  @apply bg-astrid-blue text-white hover:bg-blue-600;
}

.action-btn.secondary {
  @apply bg-gray-600 text-gray-200 hover:bg-gray-500;
}

/* Modal styles */
.modal-overlay {
  @apply fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50;
}

.modal-content {
  @apply bg-gray-800 rounded-lg max-w-4xl w-full mx-4 max-h-[90vh] overflow-hidden;
}

.modal-header {
  @apply flex justify-between items-center p-6 border-b border-gray-700;
}

.modal-title {
  @apply text-xl font-bold text-white;
}

.close-btn {
  @apply text-gray-400 hover:text-white transition-colors;
}

.modal-body {
  @apply p-6 overflow-y-auto max-h-[60vh];
}

.anomaly-gallery {
  @apply mb-6;
}

.main-image {
  @apply mb-4;
}

.detection-image {
  @apply w-full h-64 object-cover rounded-lg;
}

.anomaly-metadata {
  @apply space-y-6;
}

.metadata-section h3 {
  @apply text-lg font-semibold text-white mb-3;
}

.metadata-grid {
  @apply grid grid-cols-2 gap-4;
}

.metadata-item {
  @apply flex flex-col space-y-1;
}

.metadata-item label {
  @apply text-sm text-gray-400;
}

.metadata-item span {
  @apply text-white font-medium;
}

.score-highlight {
  @apply text-astrid-blue font-bold;
}

.coordinates-display {
  @apply space-y-2;
}

.coord-item {
  @apply flex justify-between;
}

.coord-item label {
  @apply text-gray-400;
}

.coord-item span {
  @apply font-mono text-white;
}

.external-resources h3 {
  @apply text-lg font-semibold text-white mb-3;
}

.resources-grid {
  @apply grid grid-cols-1 md:grid-cols-2 gap-3;
}

.resource-link {
  @apply flex items-center space-x-3 p-3 bg-gray-700 rounded-lg hover:bg-gray-600 transition-colors;
}

.resource-icon {
  @apply text-astrid-blue;
}

.resource-info {
  @apply flex-1;
}

.resource-name {
  @apply text-white font-medium;
}

.resource-description {
  @apply text-gray-400 text-sm;
}

.resource-arrow {
  @apply text-gray-400;
}

.modal-footer {
  @apply p-6 border-t border-gray-700;
}

.action-buttons {
  @apply flex space-x-3;
}

.btn-primary {
  @apply bg-astrid-blue text-white px-4 py-2 rounded-lg hover:bg-blue-600 transition-colors flex items-center space-x-2;
}

.btn-secondary {
  @apply bg-gray-600 text-gray-200 px-4 py-2 rounded-lg hover:bg-gray-500 transition-colors flex items-center space-x-2;
}

/* Responsive design */
@media (max-width: 768px) {
  .timeline-container {
    @apply pl-4;
  }
  
  .timeline-marker {
    @apply -left-4;
  }
  
  .metadata-grid {
    @apply grid-cols-1;
  }
  
  .resources-grid {
    @apply grid-cols-1;
  }
  
  .action-buttons {
    @apply flex-col space-x-0 space-y-2;
  }
}
```

### **Error Handling and Loading States**
- Loading skeletons for timeline entries
- Error boundaries for failed API calls
- Retry mechanisms for network failures
- Graceful degradation for missing images
- Offline support with cached data

### **Testing Strategy**
- Unit tests for timeline components
- Integration tests for API connectivity
- Visual regression tests for timeline layout
- Accessibility tests for keyboard navigation
- Performance tests for large datasets

### **Performance Considerations**
- Virtual scrolling for large timelines
- Image lazy loading and optimization
- Debounced search and filtering
- Memoized component rendering
- Efficient state management

### **Expected Deliverables**
1. **Timeline Components** - Complete React components for anomaly display
2. **Detail Views** - Modal and page views for anomaly inspection
3. **External Integration** - Links to astronomical databases and sky maps
4. **Homepage Integration** - Timeline section on main dashboard
5. **Responsive Design** - Mobile and tablet optimized layouts
6. **API Integration** - Complete data fetching and real-time updates
7. **Styling** - Professional CSS with animations and transitions

### **Success Criteria**
- Timeline displays anomalies chronologically with smooth animations
- Users can click entries to view detailed information
- External resource links work correctly and open in new tabs
- Timeline is prominently displayed on homepage and easy to navigate
- Responsive design works on all device sizes
- Real-time updates show new anomalies automatically
- Integration with existing AstrID infrastructure is seamless
