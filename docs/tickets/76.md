## **ASTR-76: Image Preprocessing Services (P2) - Core domain**

### **Context & Current State**
The FITS processing pipeline is complete (ASTR-75 ✅), providing the foundation for astronomical image processing. This ticket implements the image calibration and preprocessing pipeline that transforms raw astronomical images into science-ready data through bias/dark/flat calibration and quality assessment.

### **Technical Requirements**

**Dependencies**: ASTR-75 (FITS Processing Pipeline) - ✅ Complete
**Domain**: Core Domain (Image Processing)
**Estimated Time**: 4 days

### **Implementation Tasks**

1. **Implement Bias/Dark/Flat Calibration** ❌ **NEW TASK**
   - Create `src/domains/preprocessing/calibration/calibration_processor.py`
   - Implement `CalibrationProcessor` with methods:
     - `apply_bias_correction(image: ndarray, bias_frame: ndarray) -> ndarray`
     - `apply_dark_correction(image: ndarray, dark_frame: ndarray, exposure_time: float) -> ndarray`
     - `apply_flat_correction(image: ndarray, flat_frame: ndarray) -> ndarray`
     - `create_master_bias(bias_frames: list[ndarray]) -> ndarray`
     - `create_master_dark(dark_frames: list[ndarray], exposure_times: list[float]) -> ndarray`
     - `create_master_flat(flat_frames: list[ndarray], bias_frame: ndarray) -> ndarray`
   - Add calibration frame validation and quality checks
   - Implement robust statistics for master frame creation
   - Add calibration uncertainty propagation

2. **Enhance WCS Alignment and Registration** ✅ **PARTIALLY COMPLETE**
   - Enhance `src/domains/preprocessing/alignment/wcs_aligner.py`
   - Add advanced alignment methods:
     - `align_to_reference_image(image: ndarray, reference: ndarray, wcs: WCS) -> tuple[ndarray, WCS]`
     - `register_multiple_images(images: list[ndarray], wcs_list: list[WCS]) -> tuple[list[ndarray], list[WCS]]`
     - `calculate_alignment_transform(source_coords: ndarray, target_coords: ndarray) -> AffineTransform`
     - `apply_alignment_transform(image: ndarray, transform: AffineTransform) -> ndarray`
     - `validate_alignment_quality(aligned_image: ndarray, reference: ndarray) -> dict`
   - Add support for different alignment algorithms (cross-correlation, feature matching)
   - Implement sub-pixel alignment precision
   - Add alignment quality metrics and validation

3. **Enhance Image Quality Assessment** ✅ **PARTIALLY COMPLETE**
   - Enhance `src/domains/preprocessing/quality/quality_assessor.py`
   - Add comprehensive quality metrics:
     - `assess_image_quality(image: ndarray) -> dict`
     - `calculate_background_level(image: ndarray) -> float`
     - `calculate_noise_level(image: ndarray) -> float`
     - `detect_cosmic_rays(image: ndarray) -> ndarray`
     - `assess_flatness(image: ndarray) -> dict`
     - `calculate_saturation_level(image: ndarray) -> float`
   - Add support for different quality assessment algorithms
   - Implement quality scoring and classification
   - Add quality trend analysis over time

4. **Enhance Preprocessing Pipeline Orchestration** ✅ **PARTIALLY COMPLETE**
   - Enhance `src/domains/preprocessing/pipeline/preprocessing_pipeline.py`
   - Add comprehensive pipeline management:
     - `process_observation(observation: Observation) -> PreprocessingResult`
     - `validate_calibration_frames(observation: Observation) -> bool`
     - `select_optimal_calibration_frames(observation: Observation) -> dict`
     - `monitor_processing_progress(observation_id: UUID) -> dict`
     - `handle_processing_failure(observation_id: UUID, error: Exception) -> None`
   - Add pipeline configuration and customization
   - Implement parallel processing for multiple observations
   - Add processing result caching and optimization

### **Integration Points**

- **Domain Models**: Process observations and store preprocessing results
- **FITS Processing**: Use processed FITS data from ASTR-75
- **Storage**: Store calibration frames and processed images in cloud storage
- **Events**: Emit preprocessing completion and failure events
- **Quality Control**: Integrate with quality assessment for data validation

### **Preprocessing Pipeline Flow**
```python
@dataclass
class PreprocessingResult:
    observation_id: UUID
    calibrated_image: ndarray
    aligned_image: ndarray
    quality_metrics: dict
    calibration_metadata: dict
    processing_time: float
    processing_errors: list[str]
    output_file_path: str
```

### **Calibration Frame Management**
```python
@dataclass
class CalibrationFrames:
    bias_frames: list[ndarray]
    dark_frames: list[ndarray]
    flat_frames: list[ndarray]
    master_bias: ndarray
    master_dark: ndarray
    master_flat: ndarray
    calibration_quality: dict
    valid_until: datetime
```

### **API Endpoints to Add**
```python
POST /observations/{id}/preprocess
GET /observations/{id}/preprocessing-status
POST /observations/{id}/calibrate
GET /observations/{id}/quality-metrics
POST /calibration-frames/upload
GET /calibration-frames/{type}/latest
POST /preprocessing/pipeline/configure
```

### **Quality Assessment Metrics**
```python
@dataclass
class QualityMetrics:
    background_level: float
    noise_level: float
    cosmic_ray_count: int
    saturation_percentage: float
    flatness_score: float
    alignment_accuracy: float
    overall_quality_score: float
    quality_flags: list[str]
```

### **Error Handling**
- Calibration frame validation and error recovery
- Alignment failure detection and fallback methods
- Quality assessment failure handling
- Pipeline orchestration error recovery
- Comprehensive logging for debugging

### **Testing Strategy**
- Unit tests for all calibration algorithms
- Integration tests with real astronomical images
- Quality assessment accuracy validation
- Pipeline orchestration workflow tests
- Performance tests for large image processing
- Error handling tests for various failure scenarios

### **Performance Considerations**
- Parallel processing for multiple observations
- Memory-efficient processing for large images
- Calibration frame caching and reuse
- Progress tracking for long-running operations
- Resource management for concurrent processing
